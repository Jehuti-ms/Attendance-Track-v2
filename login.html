<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Track - Login</title>
    <link rel="stylesheet" href="./assets/css/main.css">
    <link rel="stylesheet" href="./assets/css/components.css">
    <link rel="stylesheet" href="./assets/css/theme.css">
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./assets/icons/favicon.ico">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-header">
            <div class="logo">
                <img src="./assets/icons/icon-192.png" alt="Logo" width="60" height="60">
                <h1>Attendance Track</h1>
            </div>
            <p class="tagline">Simple, powerful classroom management</p>
        </div>

        <div class="auth-card">
            <!-- Firebase Status -->
            <div class="firebase-status" id="firebase-status">
                <span id="status-text">Checking connection...</span>
            </div>

            <!-- Auth Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">
                    <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Login
                </button>
                <button class="auth-tab" data-tab="signup">
                    <svg class="tab-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="8.5" cy="7" r="4"></circle>
                        <line x1="20" y1="8" x2="20" y2="14"></line>
                        <line x1="23" y1="11" x2="17" y2="11"></line>
                    </svg>
                    Create Account
                </button>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="login-email">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        Email
                    </label>
                    <input type="email" id="login-email" placeholder="teacher@school.edu" required>
                </div>

                <div class="form-group">
                    <label for="login-password">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Password
                    </label>
                    <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    <div class="password-toggle" onclick="togglePassword('login-password')">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </div>
                </div>

                <div class="form-options">
                    <label class="checkbox">
                        <input type="checkbox" id="remember-me">
                        <span>Remember me</span>
                    </label>
                    <a href="#" class="forgot-password" onclick="showForgotPassword()">Forgot password?</a>
                </div>

                <button type="submit" class="btn-primary btn-block" id="login-submit">
                    <span class="btn-text">Sign In</span>
                    <span class="btn-loader" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke-opacity="0.3"></circle>
                            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
                        </svg>
                    </span>
                </button>
            </form>

            <!-- Sign Up Form -->
            <form id="signup-form" class="auth-form">
                <div class="form-group">
                    <label for="signup-name">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Full Name
                    </label>
                    <input type="text" id="signup-name" placeholder="John Smith" required>
                </div>

                <div class="form-group">
                    <label for="signup-email">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        Email
                    </label>
                    <input type="email" id="signup-email" placeholder="teacher@school.edu" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-password">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            Password
                        </label>
                        <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6">
                        <div class="password-toggle" onclick="togglePassword('signup-password')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="signup-confirm">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            Confirm
                        </label>
                        <input type="password" id="signup-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                        <div class="password-toggle" onclick="togglePassword('signup-confirm')">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="signup-role">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Role
                        </label>
                        <select id="signup-role" required>
                            <option value="">Select Role</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="signup-school">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                            </svg>
                            School
                        </label>
                        <input type="text" id="signup-school" placeholder="School Name">
                    </div>
                </div>

                <div class="form-group terms">
                    <label class="checkbox">
                        <input type="checkbox" id="accept-terms" required>
                        <span>I agree to the <a href="#" onclick="showTerms()">Terms of Service</a> and <a href="#" onclick="showPrivacy()">Privacy Policy</a></span>
                    </label>
                </div>

                <button type="submit" class="btn-primary btn-block" id="signup-submit">
                    <span class="btn-text">Create Account</span>
                    <span class="btn-loader" style="display: none;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke-opacity="0.3"></circle>
                            <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
                        </svg>
                    </span>
                </button>
            </form>

            <!-- Demo Mode Section -->
            <div class="auth-divider">
                <span>or continue with</span>
            </div>

            <button onclick="startDemoMode()" class="btn-secondary btn-block" id="demo-btn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                    <polyline points="2 17 12 22 22 17"></polyline>
                    <polyline points="2 12 12 17 22 12"></polyline>
                </svg>
                Try Demo Mode
            </button>

            <!-- Sign in with Google button -->
            <div class="social-auth">
                <button onclick="signInWithGoogle()" class="btn-google">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>

            <!-- Sign in with Apple -->
            <button onclick="signInWithApple()" class="btn-apple">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="#000000">
                    <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.31-2.33 1.05-3.11z"/>
                </svg>
                Continue with Apple
            </button>
            
            <!-- Status Messages -->
            <div id="auth-status" class="status-message"></div>
        </div>

        <div class="auth-footer">
            <p>Attendance Track v2.0 ‚Ä¢ Secure ‚Ä¢ Offline Capable</p>
            <p class="small">By using this app, you agree to our data handling policies</p>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const DEMO_EMAIL = "demo@attendance-track.app";
        const DEMO_PASSWORD = "demo123";

        // ==================== STATE MANAGEMENT ====================
        let currentTab = 'login';
        let firebaseAuth = null;

        // ==================== DOM READY ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Auth page loading...');
            
            await initializeFirebase();
            setupTabSwitching();
            setupForms();
            checkExistingSession();
        });

        // ==================== FIREBASE INIT ====================
        async function initializeFirebase() {
    try {
        const { auth, onAuthStateChanged } = await import('./assets/js/firebase.js');
        firebaseAuth = auth;
        
        console.log('‚úÖ Firebase loaded');
        updateFirebaseStatus('Firebase connected', 'success');
        
        // Monitor auth state - WITHOUT auto-redirect
        onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log('üë§ User session active:', user.email);
        // User stays on login page - they must submit the form
    }
});
                
                // üö® REMOVED: Auto-redirect from login page
                // Instead, just provide helpful UI feedback
                if (window.location.pathname.includes('login.html')) {
                    console.log('‚ÑπÔ∏è User already signed in via Firebase');
                    
                    // Auto-fill email field for convenience
                    const emailField = document.getElementById('login-email');
                    if (emailField && !emailField.value) {
                        emailField.value = user.email;
                    }
                    
                    // Show helpful status message
                    showStatus(`Signed in as ${user.email}. Submit form to continue.`, 'info');
                    
                    // Optional: Focus password field for quick entry
                    setTimeout(() => {
                        const passwordField = document.getElementById('login-password');
                        if (passwordField) passwordField.focus();
                    }, 500);
                }
            } else {
                console.log('üë§ No active Firebase session');
            }
        });
        
    } catch (error) {
        console.error('‚ùå Firebase init error:', error);
        updateFirebaseStatus('Firebase not available - Using offline mode', 'error');
    }
}
        
        // ==================== TAB MANAGEMENT ====================
        function setupTabSwitching() {
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = document.querySelectorAll('.auth-form');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    
                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show corresponding form
                    forms.forEach(form => {
                        form.classList.remove('active');
                        if (form.id === `${targetTab}-form`) {
                            form.classList.add('active');
                        }
                    });
                    
                    currentTab = targetTab;
                    clearStatus();
                    
                    console.log(`Switched to ${targetTab} tab`);
                });
            });
        }

        // ==================== FORM HANDLING ====================
        function setupForms() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Sign-up form
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            
            // Enter key submits form
            document.querySelectorAll('.auth-form input').forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const form = input.closest('.auth-form');
                        if (form.id === 'login-form') handleLogin(e);
                        else handleSignUp(e);
                    }
                });
            });
        }

        // ==================== LOGIN HANDLER ====================
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // Validation
            if (!email || !password) {
                showStatus('Please enter email and password', 'error');
                return;
            }
            
            // Show loading
            const btn = document.getElementById('login-submit');
            setButtonLoading(btn, true);
            
            try {
                // Check if this is demo account
                if (email === DEMO_EMAIL && password === DEMO_PASSWORD) {
                    await handleDemoLogin();
                    return;
                }
                
                // Firebase login
                if (!firebaseAuth) {
                    throw new Error('Firebase not available');
                }
                
                const { signInWithEmailAndPassword } = await import(
                    'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js'
                );
                
                const userCredential = await signInWithEmailAndPassword(firebaseAuth, email, password);
                const user = userCredential.user;
                
                // Save user data
                await saveUserToLocalStorage({
                    id: user.uid,
                    email: user.email,
                    name: user.displayName || email.split('@')[0],
                    role: 'teacher',
                    school: 'My School',
                    firebaseUID: user.uid,
                    lastLogin: new Date().toISOString()
                });
                
                // Remember me
                if (rememberMe) {
                    localStorage.setItem('remember_email', email);
                } else {
                    localStorage.removeItem('remember_email');
                }
                
                showStatus('Login successful! Redirecting...', 'success');
                
                // Redirect
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                
            } catch (error) {
                console.error('Login error:', error);
                
                let errorMessage = 'Login failed';
                switch (error.code) {
                    case 'auth/invalid-credential':
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'Invalid email or password';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Account has been disabled';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Try again later';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Check your connection';
                        break;
                    default:
                        errorMessage = `Error: ${error.message}`;
                }
                
                showStatus(errorMessage, 'error');
                
                // Offer demo mode
                setTimeout(() => {
                    if (confirm('Login failed. Try Demo Mode instead?')) {
                        startDemoMode();
                    }
                }, 2000);
                
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ==================== SIGN-UP HANDLER ====================
        async function handleSignUp(e) {
            e.preventDefault();
            
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm').value;
            const role = document.getElementById('signup-role').value;
            const school = document.getElementById('signup-school').value.trim();
            const terms = document.getElementById('accept-terms').checked;
            
            // Validation
            if (!name || !email || !password || !confirmPassword || !role) {
                showStatus('Please fill all required fields', 'error');
                return;
            }
            
            if (!terms) {
                showStatus('You must accept the terms and conditions', 'error');
                return;
            }
            
            if (password.length < 6) {
                showStatus('Password must be at least 6 characters', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showStatus('Passwords do not match', 'error');
                return;
            }
            
            // Show loading
            const btn = document.getElementById('signup-submit');
            setButtonLoading(btn, true);
            
            try {
                if (!firebaseAuth) {
                    throw new Error('Firebase not available');
                }
                
                const { createUserWithEmailAndPassword } = await import(
                    'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js'
                );
                
                // Create Firebase account
                const userCredential = await createUserWithEmailAndPassword(firebaseAuth, email, password);
                const user = userCredential.user;
                
                // Save user data
                const userData = {
                    id: user.uid,
                    name: name,
                    email: email,
                    role: role,
                    school: school || 'My School',
                    firebaseUID: user.uid,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                };
                
                await saveUserToLocalStorage(userData);
                
                // Show success
                showStatus('‚úÖ Account created successfully! Redirecting...', 'success');
                
                // Switch to login tab (for UX)
                setTimeout(() => {
                    document.querySelector('.auth-tab[data-tab="login"]').click();
                    document.getElementById('login-email').value = email;
                    document.getElementById('remember-me').checked = true;
                    
                    // Auto-login and redirect
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('Sign-up error:', error);
                
                let errorMessage = 'Account creation failed';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already registered. Please login instead.';
                        // Switch to login tab
                        setTimeout(() => {
                            document.querySelector('.auth-tab[data-tab="login"]').click();
                            document.getElementById('login-email').value = email;
                            showStatus(errorMessage, 'warning');
                        }, 500);
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password is too weak. Use at least 6 characters';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Email/password accounts are disabled';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Check your connection';
                        break;
                    default:
                        errorMessage = `Error: ${error.message}`;
                }
                
                showStatus(errorMessage, 'error');
                
            } finally {
                setButtonLoading(btn, false);
            }
        }

        // ==================== DEMO MODE ====================
        async function handleDemoLogin() {
            console.log('Starting demo mode...');
            
            const demoUser = {
                id: 'demo-' + Date.now(),
                name: 'Demo Teacher',
                email: DEMO_EMAIL,
                role: 'teacher',
                school: 'Demo Academy',
                demo: true,
                lastLogin: new Date().toISOString()
            };
            
            await saveUserToLocalStorage(demoUser);
            showStatus('Starting demo mode...', 'info');
            
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);
        }

        function startDemoMode() {
            const btn = document.getElementById('demo-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.3"></circle>
                    <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
                </svg>
                Loading...
            `;
            btn.disabled = true;
            
            // Auto-fill demo credentials
            document.getElementById('login-email').value = DEMO_EMAIL;
            document.getElementById('login-password').value = DEMO_PASSWORD;
            
            // Trigger login after a short delay
            setTimeout(() => {
                const event = new Event('submit');
                document.getElementById('login-form').dispatchEvent(event);
            }, 500);
            
            // Reset button after 3 seconds
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 3000);
        }

        // ==================== GOOGLE SIGN-IN ====================
        async function signInWithGoogle() {
            if (!firebaseAuth) {
                showStatus('Firebase not available. Please use email/password or demo mode.', 'error');
                return;
            }
        
            const btn = document.querySelector('.btn-google');
            const originalHtml = btn.innerHTML;
            
            // Show loading
            btn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-opacity="0.3"></circle>
                    <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
                </svg>
                Connecting...
            `;
            btn.disabled = true;
            
            try {
                const { signInWithPopup, googleProvider } = await import('./assets/js/firebase.js');
                
                const result = await signInWithPopup(firebaseAuth, googleProvider);
                const user = result.user;
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;
                
                console.log('Google sign-in successful:', user.email);
                
                // Extract name from Google profile
                const displayName = user.displayName || 'Google User';
                const firstName = displayName.split(' ')[0];
                const lastName = displayName.split(' ').slice(1).join(' ') || '';
                
                // Check if this is a new or existing user
                const isNewUser = result._tokenResponse?.isNewUser || false;
                
                // Create user profile
                const userData = {
                    id: user.uid,
                    name: displayName,
                    firstName: firstName,
                    lastName: lastName,
                    email: user.email,
                    photoURL: user.photoURL,
                    role: 'teacher', // Default role for Google sign-ups
                    school: user.email.includes('edu') ? 'Educational Institution' : 'My School',
                    firebaseUID: user.uid,
                    authProvider: 'google',
                    googleAccessToken: token,
                    lastLogin: new Date().toISOString(),
                    createdAt: isNewUser ? new Date().toISOString() : undefined
                };
                
                await saveUserToLocalStorage(userData);
                
                // Show appropriate message
                if (isNewUser) {
                    showStatus('‚úÖ Welcome! Account created with Google.', 'success');
                } else {
                    showStatus('‚úÖ Welcome back! Signed in with Google.', 'success');
                }
                
                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                
            } catch (error) {
                console.error('Google sign-in error:', error);
                
                let errorMessage = 'Google sign-in failed';
                
                switch (error.code) {
                    case 'auth/popup-blocked':
                        errorMessage = 'Popup was blocked by browser. Please allow popups for this site.';
                        // Fallback to redirect
                        setTimeout(() => {
                            showStatus('Trying alternative method...', 'info');
                            signInWithGoogleRedirect();
                        }, 1000);
                        break;
                    case 'auth/popup-closed-by-user':
                        errorMessage = 'Sign-in was cancelled.';
                        break;
                    case 'auth/cancelled-popup-request':
                        errorMessage = 'Sign-in was cancelled.';
                        break;
                    case 'auth/unauthorized-domain':
                        errorMessage = 'This domain is not authorized. Please contact support.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection.';
                        break;
                    default:
                        errorMessage = `Error: ${error.message}`;
                }
                
                showStatus(errorMessage, 'error');
                
                // Reset button after delay
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                }, 2000);
            }
        }
        
        // Alternative redirect method if popup is blocked
        async function signInWithGoogleRedirect() {
            try {
                const { signInWithRedirect, googleProvider } = await import('./assets/js/firebase.js');
                await signInWithRedirect(firebaseAuth, googleProvider);
            } catch (error) {
                console.error('Google redirect error:', error);
                showStatus('Failed to redirect. Please try email login.', 'error');
            }
        }
        
        // Handle redirect result (if using redirect method)
        async function handleRedirectResult() {
            try {
                const { getRedirectResult } = await import(
                    'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js'
                );
                
                const result = await getRedirectResult(firebaseAuth);
                if (result) {
                    const user = result.user;
                    console.log('Google redirect sign-in successful:', user.email);
                    
                    // Process user data as above
                    // ...
                }
            } catch (error) {
                console.error('Redirect result error:', error);
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        async function saveUserToLocalStorage(userData) {
            localStorage.setItem('attendance_user', JSON.stringify(userData));
            console.log('User saved to localStorage:', userData.email);
        }

        function checkExistingSession() {
            const savedEmail = localStorage.getItem('remember_email');
            if (savedEmail) {
                document.getElementById('login-email').value = savedEmail;
                document.getElementById('remember-me').checked = true;
            }
            
            // Check if already logged in
            const user = JSON.parse(localStorage.getItem('attendance_user'));
            if (user && !window.location.pathname.includes('login.html')) {
                console.log('User already logged in:', user.email);
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const type = input.type === 'password' ? 'text' : 'password';
            input.type = type;
        }

        function setButtonLoading(button, isLoading) {
            const text = button.querySelector('.btn-text');
            const loader = button.querySelector('.btn-loader');
            
            if (isLoading) {
                text.style.display = 'none';
                loader.style.display = 'inline-block';
                button.disabled = true;
            } else {
                text.style.display = 'inline-block';
                loader.style.display = 'none';
                button.disabled = false;
            }
        }

        function updateFirebaseStatus(message, type) {
            const statusDiv = document.getElementById('firebase-status');
            const statusText = document.getElementById('status-text');
            
            statusText.textContent = message;
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.borderColor = '#c3e6cb';
                statusText.style.color = '#155724';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.borderColor = '#f5c6cb';
                statusText.style.color = '#721c24';
            } else {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.borderColor = '#bee5eb';
                statusText.style.color = '#0c5460';
            }
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message';
            
            if (type === 'success') {
                statusDiv.classList.add('success');
            } else if (type === 'error') {
                statusDiv.classList.add('error');
            } else if (type === 'warning') {
                statusDiv.classList.add('warning');
            } else {
                statusDiv.classList.add('info');
            }
            
            // Auto-hide after 5 seconds for success/info
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = 'status-message';
                }, 5000);
            }
        }

        function clearStatus() {
            const statusDiv = document.getElementById('auth-status');
            statusDiv.textContent = '';
            statusDiv.className = 'status-message';
        }

        function showForgotPassword() {
            const email = document.getElementById('login-email').value || prompt('Enter your email:');
            if (email) {
                showStatus(`Password reset link would be sent to ${email}`, 'info');
                // Note: Implement Firebase password reset here
            }
        }

        function showTerms() {
            alert('Terms of Service: This app is for educational use. Data is stored locally with optional cloud sync via Firebase.');
        }

        function showPrivacy() {
            alert('Privacy Policy: Your data is stored locally. Cloud sync is optional. We do not share your data with third parties.');
        }

        // ==================== PWA OFFLINE SUPPORT ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('‚úÖ Service Worker registered'))
                    .catch(err => console.log('‚ùå Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
